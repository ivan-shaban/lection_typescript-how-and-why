### `Typescript:` как и зачем мы его используем на проекте shop2.0

---

### Содержание

- описание проекта
- предпосылки для перехода
- процесс миграции
- подведение итогов

---

### Особенности проекта

@ul[spaced]
- shop2.0 это проект магазина внутриигрового клиента включающий большое кол-во интеграций с различными сервисами
- 80 000 строчек кода на фронтенде
- больше года активной разработки 
- команда 5+ человек
- к моменту интеграции проект уже был на 80% написан
- используется современный веб-стек технологий (`React16`, `Redux`, `Reselect`, etc)
@ulend

---

### Почему не использовали с начала проекта

- не было нужных специалистов на этапе старта проекта
- не было явных бенефитов от использования новой, неизвестной нам технологии
- завышенные ожидания о сложности изучения технологии
- требовался "быстрый старт" на основе прототипов

---

### Предпосылки для перехода

- несколько источников данных, которые надо привести к единому виду
- высокий порог вхождения в проект
- сложный рефакторинг
- быстрое и непрозрачное устаревание тестов
- запутанные селекторы
- глубокая вложенность передачи данных по дереву компонентов

---

### Почему именно `typescript`

---

### Были рассмотрены технологии:

@ul[spaced]
- `typescript`
- `flow`
- какая-то-либа-для-функционального-программирования
@ulend

---

### Преимущества перед конкурентами:

@ul[spaced]
- большое комьюнити
- хорошая документация
- четкий роадмап
- поддерживается `Microsoft`
- хорошая интеграция с наиболее популярными IDE
- большая база типизированных библиотек от сторонних разработчиков
- опциональная типизация
@ulend
// TODO: добавить анимированный пример валидации типов на примере функции normalizeData

---

### Процесс миграции

---

### Конфигурация

```diff
// webpack.config.js
module: {
    rules: [
        {
            oneOf: [
+                {
+                    test: [/\.tsx?$/],
+                    include: [paths.appSrc],
+                    use: [
+                        {
+                            loader: 'ts-loader',
+                            options: { transpileOnly: true },
+                        }
+                    ],
+                },
                {
                    test: /\.s?css$/,
                    use: [
                        { loader: require.resolve('style-loader') },
+                        {
+                            loader: require.resolve('typings-for-css-modules-loader'),
+                            options: {
+                                modules: true,
+                                camelCase: true,
+                                localIdentName: '[name]_[local]--[hash:base64:5]',
+                                importLoaders: 1,
+                                sourceMap: true,
+                                namedExport: true,
+                            },
+                        },
                    ],
                },
                // another loaders
            ],
        },
    ],
    // another options
},
```

+++
```json
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": "./src", // enables absolute path imports
    "outDir": "dist", // target for compiled files
    "allowSyntheticDefaultImports": true, // no errors on commonjs default import
    "esModuleInterop": true,
    "allowJs": true, // include js files
    "jsx": "react", // process JSX
    "lib": ["dom", "es2016", "es2017.object"],
    "target": "es5", // "es2015" for ES6+ engines
    "module": "commonjs", // "es2015" for tree-shaking
    "moduleResolution": "node",
    "noEmitOnError": true,
    "noFallthroughCasesInSwitch": true,
    "noImplicitAny": true,
    "noImplicitReturns": true,
    "noImplicitThis": true,
    "suppressImplicitAnyIndexErrors": true,
    "strictNullChecks": false,
    "noUnusedLocals": true,
    "strict": true,
    "removeComments": true,
    "sourceMap": true,
    "typeRoots": [
      "src/typings",
      "node_modules/@types"
    ]
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}

```
---

### Порядок миграции

@ul[spaced]
- стейт
- источники данных (форматы ответов от различных сервисов)
- новые файлы
- редьюсеры и экшены 
- селекторы 
- компоненты и тесты
@ulend

---

### Пошаговая миграция модуля

@ul[spaced]
- переименовать модуль изменив расширение файла
- типизировать аргументы функций
- если возвращаемый тип функции может вычислиться, то можно не обьявлять тип явно
- использовать где возможно готовые типы, если их нет использовать `any` или описать
- использовать `enum` где возможно
- пофиксить ошибки
- прогнать тесты и линтеры
- убедиться что все хорошо
- компонент мигрирован, поздравляю!
@ulend

---

### Проблемы

@ul[spaced]
- `jest` не мог явно зарезолвить смешанные импорты (`.jsx?` \ `.tsx?`)
- `jest` проблемы с async тестами (неудобный синтаксис)
- `jest` проблема с моками (много бойлерплейта)
- `webpack` долго собирался 
- `reselect` нельзя использовать spread в старой версии библиотеки
- проблема с `postcss` переменными
- беспорядок с размещением интерфейсов
- не очевидная работа `enum` из коробки
- плагин локализации не поддерживает typescript
- стали больше писать кода
@ulend

---

### Бенефиты

@ul[spaced]
- код стал более читаемым
- снижен порог входа в проект
- рефакторить стало проще
- сократилось время обнаружения ошибки
- повысилась надежность кодобазы
- повысилось удобство написания кода (автокомплит)
- практически не тратится время на ручное отслеживание зависимостей, когда ты искал где метод вызывается, какие параметры в него передаются и т.д., что бы определить насколько правильно он используется в целом
@ulend

---

@ul[spaced]
- все проверки типов выполняются на этапе компиляции, а не на рантайме, частично это замена `PropTypes`, частично `immutablejs`
- `generics` и вычисляемые типы, очень сильно развязывают руки, позволяя очень гибко описывать зависимости (например у нас тип `RootState`, вычисляется на основании обьектов из которых он состоит)
- работа со сторонними сервисами и стейтом стала простой и прозрачной
- работа с `css` стала более прозрачной (есть список все классов для компонента)
- юниттесты покрывают актуальное состояние тестируемых обьектов
- стали меньше писать кода
@ulend

---

### Выводы и рассуждения

@ul[spaced]
- javascript показывает как код работает, typescript показывает как код использовать
- typescript не замена юниттестам!
- юниттесты нужны
- появились ли у нас специалисты по typescript?
- если бы у нас была возможность откатиться в начало разработки, начали ли бы мы использовать typescript сразу?
- хотели бы мы перенести процесс миграции на время после релиза, если бы была такая возможность?
- будем ли мы использовать typescript в новых проектах со старта?
@ulend

---

### Планы на будущее

- strictNullChecks
- strictBindCallApply
- `web2client` на typescript
- `react-wot-bootstrap` на typescript
- Использовать `babel-preset-typescript` в `babel 7`

---

### Вопросы?

---

### Спасибо!
